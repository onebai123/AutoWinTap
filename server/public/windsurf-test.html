<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windsurf è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d4aa; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .card { 
            background: #16213e; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 16px;
            border: 1px solid #0f3460;
        }
        .card h3 { margin-top: 0; color: #00d4aa; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input, textarea { 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #0f3460;
            background: #0f3460;
            color: #fff;
            font-size: 14px;
        }
        input:focus, textarea:focus { outline: 2px solid #00d4aa; }
        input[type="number"] { width: 100px; }
        textarea { width: 100%; min-height: 80px; resize: vertical; }
        button { 
            padding: 10px 20px; 
            border-radius: 6px; 
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #00d4aa; color: #000; }
        .btn-primary:hover { background: #00b894; }
        .btn-secondary { background: #0f3460; color: #fff; }
        .btn-secondary:hover { background: #1a4a7a; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .status { 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 13px;
            margin-top: 10px;
        }
        .status.success { background: #00d4aa22; color: #00d4aa; }
        .status.error { background: #e74c3c22; color: #e74c3c; }
        .status.info { background: #3498db22; color: #3498db; }
        #log { 
            background: #0a0a15; 
            padding: 15px; 
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 4px; }
        .log-success { background: #00d4aa15; }
        .log-error { background: #e74c3c15; }
        .coord-display { 
            font-size: 24px; 
            font-weight: bold; 
            color: #00d4aa;
            padding: 10px;
            background: #0f3460;
            border-radius: 8px;
            display: inline-block;
        }
        img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ¤– Windsurf è‡ªåŠ¨åŒ–æµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯• IDE è‡ªåŠ¨åŒ–åŠŸèƒ½</p>

    <!-- çŠ¶æ€æ£€æŸ¥ -->
    <div class="card">
        <h3>ğŸ“¡ è¿æ¥çŠ¶æ€</h3>
        <div class="row">
            <button class="btn-primary" onclick="checkHealth()">æ£€æŸ¥ Agent</button>
            <button class="btn-secondary" onclick="getWindowInfo()">è·å–çª—å£ä¿¡æ¯</button>
        </div>
        <div id="healthStatus"></div>
    </div>

    <!-- åæ ‡è®¾ç½® -->
    <div class="card">
        <h3>ğŸ¯ è¾“å…¥æ¡†åæ ‡</h3>
        
        <!-- å»¶è¿Ÿæ•è· -->
        <div class="row">
            <button class="btn-primary" id="delayBtn" onclick="delayCapture(3)">â±ï¸ 3ç§’åæ•è·</button>
            <button class="btn-secondary" onclick="delayCapture(5)">5ç§’åæ•è·</button>
            <button class="btn-secondary" onclick="getMousePosition()">ç«‹å³è·å–</button>
            <span class="coord-display" id="mouseCoord">X: ?, Y: ?</span>
        </div>
        <div id="countdown" style="font-size:48px; color:#00d4aa; text-align:center; display:none;">3</div>
        <p style="color:#888; font-size:12px; margin:5px 0;">ç‚¹å‡»åç§»åŠ¨é¼ æ ‡åˆ°è¾“å…¥æ¡†ï¼Œå€’è®¡æ—¶ç»“æŸè‡ªåŠ¨æ•è·</p>
        
        <!-- è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰ -->
        <div style="margin-top: 15px; padding: 15px; background: #1a4a1a; border-radius: 8px; border: 2px solid #00d4aa;">
            <h4 style="margin:0 0 10px 0; color: #00d4aa;">ğŸš€ è‡ªåŠ¨æ£€æµ‹ï¼ˆæ¨èï¼‰</h4>
            <div class="row">
                <button class="btn-primary" style="font-size:16px; padding:12px 24px;" onclick="autoDetect()">
                    ğŸ” ä¸€é”®è‡ªåŠ¨æ£€æµ‹è¾“å…¥æ¡†ä½ç½®
                </button>
            </div>
            <div id="autoResult" style="margin-top:10px; font-family: monospace; font-size:13px;"></div>
        </div>
        
        <!-- æ‰‹åŠ¨è°ƒæ•´ -->
        <div style="margin-top: 15px; padding: 15px; background: #0f3460; border-radius: 8px;">
            <h4 style="margin:0 0 10px 0; color: #888;">ğŸ“ æ‰‹åŠ¨è°ƒæ•´æ¯”ä¾‹</h4>
            <div class="row">
                <label style="width:150px;">è·å³è¾¹æ¯”ä¾‹:</label>
                <input type="number" id="ratioX" step="0.01" value="0.13" style="width:80px;">
                <label style="width:100px;">è·åº•éƒ¨åƒç´ :</label>
                <input type="number" id="offsetY" value="55" style="width:80px;">
            </div>
            <div class="row" style="margin-top:10px;">
                <button class="btn-secondary" onclick="setInputRatio()">è®¾ç½®æ¯”ä¾‹</button>
                <button class="btn-secondary" onclick="calcInputPosition()">è®¡ç®—åæ ‡</button>
            </div>
            <div id="calcResult" style="margin-top:10px; font-family: monospace; font-size:12px;"></div>
        </div>
        
        <!-- å›ºå®šåæ ‡ -->
        <div style="margin-top: 15px;">
            <h4 style="margin:0 0 10px 0; color: #888;">ğŸ“ å›ºå®šåæ ‡</h4>
            <div class="row">
                <input type="number" id="inputX" placeholder="X" value="851">
                <input type="number" id="inputY" placeholder="Y" value="839">
                <button class="btn-secondary" onclick="setInputPosition()">è®¾ç½®å›ºå®šåæ ‡</button>
                <button class="btn-secondary" onclick="useCurrentMouse()">ç”¨å½“å‰é¼ æ ‡</button>
            </div>
        </div>
        <div id="posStatus"></div>
    </div>

    <!-- å‘é€æ¶ˆæ¯ -->
    <div class="card">
        <h3>ğŸ“¤ å‘é€æ¶ˆæ¯</h3>
        <textarea id="message" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯...">hello from test page</textarea>
        <div class="row">
            <button class="btn-primary" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
            <button class="btn-secondary" onclick="sendWithCoord()">ä½¿ç”¨æŒ‡å®šåæ ‡å‘é€</button>
        </div>
        <div id="sendStatus"></div>
    </div>

    <!-- å¿«æ·æ“ä½œ -->
    <div class="card">
        <h3>âš¡ å¿«æ·æ“ä½œ</h3>
        <div class="row">
            <button class="btn-secondary" onclick="hotkey('ctrl+s')">ğŸ’¾ ä¿å­˜</button>
            <button class="btn-secondary" onclick="hotkey('f5')">â–¶ï¸ è¿è¡Œ</button>
            <button class="btn-secondary" onclick="hotkey('shift+f5')">â¹ï¸ åœæ­¢</button>
            <button class="btn-secondary" onclick="hotkey('ctrl+`')">ğŸ’» ç»ˆç«¯</button>
            <button class="btn-secondary" onclick="hotkey('shift+alt+f')">âœ¨ æ ¼å¼åŒ–</button>
            <button class="btn-secondary" onclick="hotkey('escape')">âŒ Escape</button>
        </div>
        <div id="hotkeyStatus"></div>
    </div>

    <!-- æˆªå›¾ -->
    <div class="card">
        <h3>ğŸ“· æˆªå›¾</h3>
        <button class="btn-primary" onclick="captureScreen()">æˆªå›¾</button>
        <div id="screenshotContainer"></div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="card">
        <h3>ğŸ“‹ æ—¥å¿—</h3>
        <button class="btn-danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        const DEVICE_ID = '27349e69-0ca3-4279-8b19-6541c70fe807';
        let currentMouseX = 0, currentMouseY = 0;

        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="status ${type}">${msg}</div>`;
        }

        async function callAgent(plugin, action, params = {}) {
            try {
                const res = await fetch(`${API_BASE}/api/agents/${DEVICE_ID}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plugin, action, params })
                });
                return await res.json();
            } catch (e) {
                return { success: false, error: e.message };
            }
        }

        async function checkHealth() {
            log('æ£€æŸ¥ Agent çŠ¶æ€...');
            try {
                const res = await fetch('http://localhost:5200/health');
                const data = await res.json();
                showStatus('healthStatus', `âœ… Agent åœ¨çº¿ | æ’ä»¶: ${data.plugins.join(', ')}`, 'success');
                log('Agent åœ¨çº¿', 'success');
            } catch (e) {
                showStatus('healthStatus', 'âŒ Agent ç¦»çº¿', 'error');
                log('Agent ç¦»çº¿: ' + e.message, 'error');
            }
        }

        async function getMousePosition() {
            log('è·å–é¼ æ ‡ä½ç½®...');
            const result = await callAgent('windsurf', 'get-mouse-position');
            if (result.success) {
                currentMouseX = result.data.x;
                currentMouseY = result.data.y;
                document.getElementById('mouseCoord').textContent = `X: ${currentMouseX}, Y: ${currentMouseY}`;
                log(`é¼ æ ‡ä½ç½®: (${currentMouseX}, ${currentMouseY})`, 'success');
            } else {
                log('è·å–å¤±è´¥: ' + result.error, 'error');
            }
        }

        function useCurrentMouse() {
            if (currentMouseX > 0) {
                document.getElementById('inputX').value = currentMouseX;
                document.getElementById('inputY').value = currentMouseY;
                log(`å·²å¡«å…¥åæ ‡: (${currentMouseX}, ${currentMouseY})`);
            }
        }

        async function setInputPosition() {
            const x = parseInt(document.getElementById('inputX').value);
            const y = parseInt(document.getElementById('inputY').value);
            log(`è®¾ç½®è¾“å…¥æ¡†åæ ‡: (${x}, ${y})...`);
            const result = await callAgent('windsurf', 'set-input-position', { x, y });
            if (result.success) {
                showStatus('posStatus', `âœ… åæ ‡å·²è®¾ç½®: (${x}, ${y})`, 'success');
                log('åæ ‡è®¾ç½®æˆåŠŸ', 'success');
            } else {
                showStatus('posStatus', 'âŒ è®¾ç½®å¤±è´¥', 'error');
                log('è®¾ç½®å¤±è´¥: ' + result.error, 'error');
            }
        }

        async function sendMessage() {
            const msg = document.getElementById('message').value;
            log(`å‘é€æ¶ˆæ¯: ${msg}`);
            const result = await callAgent('windsurf', 'send-message', { message: msg });
            if (result.success) {
                showStatus('sendStatus', `âœ… å‘é€æˆåŠŸ (${result.data.timestamp})`, 'success');
                log('å‘é€æˆåŠŸ', 'success');
            } else {
                showStatus('sendStatus', 'âŒ å‘é€å¤±è´¥: ' + result.error, 'error');
                log('å‘é€å¤±è´¥: ' + result.error, 'error');
            }
        }

        async function sendWithCoord() {
            const msg = document.getElementById('message').value;
            const x = parseInt(document.getElementById('inputX').value);
            const y = parseInt(document.getElementById('inputY').value);
            log(`å‘é€æ¶ˆæ¯åˆ° (${x}, ${y}): ${msg}`);
            const result = await callAgent('windsurf', 'send-message', { message: msg, x, y });
            if (result.success) {
                showStatus('sendStatus', `âœ… å‘é€æˆåŠŸ (${result.data.timestamp})`, 'success');
                log('å‘é€æˆåŠŸ', 'success');
            } else {
                showStatus('sendStatus', 'âŒ å‘é€å¤±è´¥: ' + result.error, 'error');
                log('å‘é€å¤±è´¥: ' + result.error, 'error');
            }
        }

        async function hotkey(keys) {
            log(`æ‰§è¡Œå¿«æ·é”®: ${keys}`);
            const result = await callAgent('windsurf', 'hotkey', { keys });
            if (result.success) {
                showStatus('hotkeyStatus', `âœ… ${keys} æ‰§è¡ŒæˆåŠŸ`, 'success');
                log('å¿«æ·é”®æ‰§è¡ŒæˆåŠŸ', 'success');
            } else {
                showStatus('hotkeyStatus', 'âŒ æ‰§è¡Œå¤±è´¥', 'error');
                log('æ‰§è¡Œå¤±è´¥: ' + result.error, 'error');
            }
        }

        async function getWindowInfo() {
            log('è·å–çª—å£ä¿¡æ¯...');
            const result = await callAgent('windsurf', 'get-window-info');
            if (result.success) {
                const d = result.data;
                showStatus('healthStatus', 
                    `ğŸ“ çª—å£: ${d.width}x${d.height} @ (${d.left}, ${d.top}) | ä¼°è®¡è¾“å…¥æ¡†: (${d.estimatedInputBox.x}, ${d.estimatedInputBox.y})`, 
                    'info');
                log(`çª—å£ä¿¡æ¯: ${d.width}x${d.height}`, 'success');
            }
        }

        async function captureScreen() {
            log('æˆªå›¾ä¸­...');
            const result = await callAgent('window-control', 'capture-screen');
            if (result.success) {
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + result.data.image;
                const container = document.getElementById('screenshotContainer');
                container.innerHTML = '';
                container.appendChild(img);
                log('æˆªå›¾æˆåŠŸ', 'success');
            } else {
                log('æˆªå›¾å¤±è´¥: ' + result.error, 'error');
            }
        }

        // å»¶è¿Ÿæ•è·é¼ æ ‡
        async function delayCapture(seconds) {
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';
            log(`${seconds}ç§’åæ•è·é¼ æ ‡ï¼Œè¯·ç§»åŠ¨åˆ°è¾“å…¥æ¡†...`);
            
            // å€’è®¡æ—¶
            for (let i = seconds; i > 0; i--) {
                countdownEl.textContent = i;
                countdownEl.style.color = i <= 2 ? '#e74c3c' : '#00d4aa';
                await new Promise(r => setTimeout(r, 1000));
            }
            
            countdownEl.textContent = 'ğŸ“';
            
            // æ•è·
            const result = await callAgent('windsurf', 'get-mouse-position');
            if (result.success) {
                currentMouseX = result.data.x;
                currentMouseY = result.data.y;
                document.getElementById('mouseCoord').textContent = `X: ${currentMouseX}, Y: ${currentMouseY}`;
                document.getElementById('inputX').value = currentMouseX;
                document.getElementById('inputY').value = currentMouseY;
                log(`âœ… æ•è·æˆåŠŸ: (${currentMouseX}, ${currentMouseY})`, 'success');
                
                // è‡ªåŠ¨è®¡ç®—æ¯”ä¾‹
                const winResult = await callAgent('windsurf', 'get-window-info');
                if (winResult.success) {
                    const w = winResult.data;
                    const ratioX = (w.right - currentMouseX) / w.width;
                    const offsetY = w.bottom - currentMouseY;
                    document.getElementById('ratioX').value = ratioX.toFixed(3);
                    document.getElementById('offsetY').value = offsetY;
                    log(`ğŸ“ è®¡ç®—æ¯”ä¾‹: ratioX=${ratioX.toFixed(3)}, offsetY=${offsetY}`);
                }
            } else {
                log('æ•è·å¤±è´¥', 'error');
            }
            
            setTimeout(() => { countdownEl.style.display = 'none'; }, 1000);
        }

        // è®¾ç½®æ¯”ä¾‹
        async function setInputRatio() {
            const ratioX = parseFloat(document.getElementById('ratioX').value);
            const offsetY = parseInt(document.getElementById('offsetY').value);
            log(`è®¾ç½®æ¯”ä¾‹: ratioX=${ratioX}, offsetY=${offsetY}`);
            
            const result = await callAgent('windsurf', 'set-input-ratio', { ratioX, offsetY });
            if (result.success) {
                const calc = result.data.calculatedPosition;
                if (calc) {
                    document.getElementById('calcResult').innerHTML = 
                        `âœ… è®¡ç®—ç»“æœ: <strong>(${calc.x}, ${calc.y})</strong><br>` +
                        `çª—å£: ${calc.window.width}x${calc.window.height} @ (${calc.window.left}, ${calc.window.top})`;
                    log(`æ¯”ä¾‹è®¾ç½®æˆåŠŸï¼Œè®¡ç®—åæ ‡: (${calc.x}, ${calc.y})`, 'success');
                }
            } else {
                log('è®¾ç½®å¤±è´¥: ' + result.error, 'error');
            }
        }

        // è®¡ç®—åæ ‡
        async function calcInputPosition() {
            log('è®¡ç®—è¾“å…¥æ¡†ä½ç½®...');
            const result = await callAgent('windsurf', 'calc-input-position');
            if (result.success) {
                const d = result.data;
                document.getElementById('calcResult').innerHTML = 
                    `âœ… è®¡ç®—ç»“æœ: <strong>(${d.x}, ${d.y})</strong><br>` +
                    `çª—å£: ${d.window.width}x${d.window.height} @ (${d.window.left}, ${d.window.top})<br>` +
                    `æ¯”ä¾‹: ratioX=${d.ratio.ratioX}, offsetY=${d.ratio.offsetY}`;
                document.getElementById('inputX').value = d.x;
                document.getElementById('inputY').value = d.y;
                log(`è®¡ç®—å®Œæˆ: (${d.x}, ${d.y})`, 'success');
            } else {
                log('è®¡ç®—å¤±è´¥: ' + result.error, 'error');
            }
        }

        // è‡ªåŠ¨æ£€æµ‹
        async function autoDetect() {
            log('ğŸ” è‡ªåŠ¨æ£€æµ‹è¾“å…¥æ¡†ä½ç½®...');
            const result = await callAgent('windsurf', 'auto-detect');
            
            if (result.success) {
                const d = result.data;
                const html = `
                    <div style="color:#00d4aa;">âœ… ${d.message}</div>
                    <div style="margin-top:8px;">
                        ğŸ“º å±å¹•: ${d.screen.width} x ${d.screen.height}<br>
                        ğŸªŸ çª—å£: ${d.window.width} x ${d.window.height} 
                        ${d.window.isFullScreen ? '<span style="color:#00d4aa;">(å…¨å±)</span>' : ''}<br>
                        ğŸ“ è¾“å…¥æ¡†: <strong style="color:#00d4aa; font-size:16px;">(${d.inputBox.x}, ${d.inputBox.y})</strong><br>
                        ğŸ“ æ¯”ä¾‹: ratioX=${d.inputBox.ratioX}, offsetY=${d.inputBox.offsetY}
                    </div>
                `;
                document.getElementById('autoResult').innerHTML = html;
                document.getElementById('inputX').value = d.inputBox.x;
                document.getElementById('inputY').value = d.inputBox.y;
                document.getElementById('ratioX').value = d.inputBox.ratioX;
                document.getElementById('offsetY').value = d.inputBox.offsetY;
                log(`âœ… è‡ªåŠ¨æ£€æµ‹æˆåŠŸ: (${d.inputBox.x}, ${d.inputBox.y})`, 'success');
            } else {
                document.getElementById('autoResult').innerHTML = 
                    `<div style="color:#e74c3c;">âŒ æ£€æµ‹å¤±è´¥: ${result.error}</div>`;
                log('æ£€æµ‹å¤±è´¥: ' + result.error, 'error');
            }
        }

        // åˆå§‹åŒ–
        checkHealth();
        autoDetect();  // è‡ªåŠ¨æ£€æµ‹
    </script>
</body>
</html>
